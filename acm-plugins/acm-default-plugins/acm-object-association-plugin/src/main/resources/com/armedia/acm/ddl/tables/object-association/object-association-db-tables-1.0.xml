<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
            http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <property name="timestampType" value="TIMESTAMP WITH TIME ZONE" dbms="oracle,postgresql"/>
    <property name="timestampType" value="TIMESTAMP" dbms="mysql"/>

    <changeSet id="01-create-object-association-table" author="dmiller" dbms="oracle">
        <createTable tableName="acm_object_association">
            <column name="cm_association_id" type="RAW(16)" defaultValueComputed="SYS_GUID()" >
                <constraints
                        primaryKey="true"
                        primaryKeyName="pk_object_association"/>
            </column>
            <column name="cm_association_status" type="VARCHAR(128)" defaultValue="ACTIVE">
                <constraints nullable="false"/>
            </column>
            <column name="cm_object_assn_created" type="${timestampType}">
                <constraints nullable="false"/>
            </column>
            <column name="cm_object_assn_creator" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_object_assn_modified" type="${timestampType}">
                <constraints nullable="false"/>
            </column>
            <column name="cm_object_assn_modifier" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_parent_type" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_parent_id" type="RAW(16)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_parent_name" type="VARCHAR(1024)">
                <constraints nullable="true"/>
            </column>
            <column name="cm_target_type" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_target_id" type="RAW(16)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_target_name" type="VARCHAR(1024)">
                <constraints nullable="true"/>
            </column>
        </createTable>

        <createIndex tableName="acm_object_association" indexName="idx_object_assn_parent_id">
            <column name="cm_parent_id"/>
        </createIndex>
        <createIndex tableName="acm_object_association" indexName="idx_object_assn_target_id">
            <column name="cm_target_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="01-create-object-association-table" author="dmiller" dbms="postgresql,mysql">
        <createTable tableName="acm_object_association">
            <column name="cm_association_id" type="NUMBER(32,0)">
                <constraints
                        primaryKey="true"
                        primaryKeyName="pk_object_association"/>
            </column>
            <column name="cm_association_status" type="VARCHAR(128)" defaultValue="ACTIVE">
                <constraints nullable="false"/>
            </column>
            <column name="cm_object_assn_created" type="${timestampType}">
                <constraints nullable="false"/>
            </column>
            <column name="cm_object_assn_creator" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_object_assn_modified" type="${timestampType}">
                <constraints nullable="false"/>
            </column>
            <column name="cm_object_assn_modifier" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_parent_type" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_parent_id" type="NUMBER(32,0)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_parent_name" type="VARCHAR(1024)">
                <constraints nullable="true"/>
            </column>
            <column name="cm_target_type" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_target_id" type="NUMBER(32,0)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_target_name" type="VARCHAR(1024)">
                <constraints nullable="true"/>
            </column>
        </createTable>

        <createIndex tableName="acm_object_association" indexName="idx_object_assn_parent_id">
            <column name="cm_parent_id"/>
        </createIndex>
        <createIndex tableName="acm_object_association" indexName="idx_object_assn_target_id">
            <column name="cm_target_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="02-widen-object-names" author="dmiller">
        <modifyDataType tableName="acm_object_association" columnName="cm_parent_name" newDataType="VARCHAR2(4000)"/>
        <modifyDataType tableName="acm_object_association" columnName="cm_target_name" newDataType="VARCHAR2(4000)"/>
    </changeSet>

    <changeSet id="03-object-assn-switch-to-sequence-pk" author="dmiller">
        <dropDefaultValue tableName="acm_object_association" columnName="cm_association_id"/>
        <modifyDataType tableName="acm_object_association" columnName="cm_association_id" newDataType="NUMBER(32,0)"/>
    </changeSet>

    <changeSet id="04-fix-object-id-type" author="dmiller">
        <modifyDataType tableName="acm_object_association" columnName="cm_parent_id" newDataType="NUMBER(32,0)"/>
        <modifyDataType tableName="acm_object_association" columnName="cm_target_id" newDataType="NUMBER(32,0)"/>
    </changeSet>

    <changeSet id="object-association-05-add-category-and-subtype" author="dmiller">
        <addColumn tableName="acm_object_association">
            <column name="cm_target_category" type="VARCHAR(128)"/>
        </addColumn>
        <addColumn tableName="acm_object_association">
            <column name="cm_target_subtype" type="VARCHAR(128)"/>
        </addColumn>
    </changeSet>

    <changeSet id="object-association-06-add-association-type" author="dmiller">
        <addColumn tableName="acm_object_association">
            <column name="cm_association_type" type="VARCHAR(128)"/>
        </addColumn>
    </changeSet>

    <changeSet id="object-association-07-populate-association-type" author="dmiller">
        <update tableName="acm_object_association">
            <column name="cm_association_type" value="REFERENCE"/>
            <where>cm_target_type IN ('CASE', 'CASE_FILE', 'COMPLAINT')</where>
        </update>
        <update tableName="acm_object_association">
            <column name="cm_association_type" value="OWNERSHIP"/>
            <where>cm_target_type NOT IN ('CASE', 'CASE_FILE', 'COMPLAINT')</where>
        </update>
    </changeSet>

</databaseChangeLog>

