<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="
            http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <property name="complaintNumberLength" value="1024" dbms="postgresql,oracle"/>
    <property name="complaintNumberLength" value="255" dbms="mysql"/>

    <property name="cmValueLength" value="4000" dbms="postgresql,oracle"/>
    <property name="cmValueLength" value="255" dbms="mysql"/>

    <property name="cmOrderLength" value="NUMBER(32,0)" dbms="postgresql,oracle"/>
    <property name="cmOrderLength" value="BIGINT" dbms="mysql"/>

    <changeSet id="01-create-complaint-table" author="dmiller">
        <createTable tableName="acm_complaint">
            <column name="cm_complaint_id" type="${idType}" autoIncrement="${autoIncrement}" >
                <constraints
                    primaryKey="true"
                    primaryKeyName="pk_complaint"/>
            </column>
            <column name="cm_complaint_status" type="VARCHAR(128)" defaultValue="DRAFT">
                <constraints nullable="false"/>
            </column>
            <column name="cm_complaint_created" type="${timestampType}">
                <constraints nullable="false"/>
            </column>
            <column name="cm_complaint_number" type="VARCHAR(${complaintNumberLength})">
                <constraints nullable="false" unique="true" uniqueConstraintName="uk_complaint_number"/>
            </column>
            <column name="cm_complaint_creator" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_complaint_modified" type="${timestampType}">
                <constraints nullable="false"/>
            </column>
            <column name="cm_complaint_modifier" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_complaint_type" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_complaint_title" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_complaint_details" type="CLOB">
                <constraints nullable="false"/>
            </column>
            <column name="cm_originator_id" type="${fkIdType}">
                <constraints nullable="true"/>
            </column>
            <column name="cm_target_name" type="VARCHAR(1024)">
                <constraints nullable="true"/>
            </column>
            <column name="cm_complaint_incident_date" type="${timestampType}">
                <constraints nullable="true"/>
            </column>
            <column name="cm_complaint_priority" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex tableName="acm_complaint" indexName="idx_complaint_originator_id">
            <column name="cm_originator_id"/>
        </createIndex>

    </changeSet>

    <changeSet id="02-complaint-switch-to-sequence-pk" author="dmiller">
        <dropDefaultValue tableName="acm_complaint" columnName="cm_complaint_id"/>
        <modifyDataType tableName="acm_complaint" columnName="cm_complaint_id" newDataType="${fkIdType}"/>
    </changeSet>

    <changeSet id="04-fix-originator-id-type" author="dmiller">
        <modifyDataType tableName="acm_complaint" columnName="cm_originator_id" newDataType="${fkIdType}"/>
    </changeSet>

    <changeSet id="05-drop-target-name-column" author="dmiller">
        <dropColumn tableName="acm_complaint" columnName="cm_target_name"/>
    </changeSet>

    <changeSet id="06-make-details-nullable" author="dmiller">
        <dropNotNullConstraint tableName="acm_complaint" columnName="cm_complaint_details" columnDataType="CLOB"/>
    </changeSet>

    <changeSet id="07-add-ecm-folder-id" author="dmiller">
        <addColumn tableName="acm_complaint">
            <column name="cm_complaint_ecm_folder_id" type="VARCHAR(1024)"/>
        </addColumn>
        <createIndex tableName="acm_complaint" indexName="idx_complaint_folder_id">
            <column name="cm_complaint_ecm_folder_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="08-drop-not-null-on-priority-type-title" author="dmiller">
        <comment>Allow creating complaint with minimal data.  These columns must be populated before it can be approved.</comment>
        <dropNotNullConstraint tableName="acm_complaint" columnName="cm_complaint_type" columnDataType="VARCHAR(1024)"/>
        <dropNotNullConstraint tableName="acm_complaint" columnName="cm_complaint_priority" columnDataType="VARCHAR(128)"/>
        <dropNotNullConstraint tableName="acm_complaint" columnName="cm_complaint_title" columnDataType="VARCHAR(1024)"/>
    </changeSet>

    <changeSet id="10-index-complaint-last-updated" author="dmiller">
        <createIndex tableName="acm_complaint" indexName="idx_complaint_modified">
            <column name="cm_complaint_modified"/>
        </createIndex>
    </changeSet>
    
    <changeSet id="11-insert-dueDate-in-complaint" author="tsedalu">
        <addColumn tableName="acm_complaint"> 
            <column name="cm_due_date" type="${timestampType}"/>
        </addColumn>     
    </changeSet>

    <changeSet id="12-add-fields-in-acm-complaint-table" author="tsedalu">
        <addColumn tableName="acm_complaint">
            <column name="cm_tag" type="VARCHAR(1024)"/>
            <column name="cm_frequency" type="VARCHAR(1024)"/>
            <column name="cm_location" type="VARCHAR(1024)"/>            
        </addColumn>
    </changeSet>

    <changeSet id="complaint-13-add-disposition-column" author="dmiller">
        <addColumn tableName="acm_complaint">
            <column name="cm_disposition_id" type="${fkIdType}"/>
        </addColumn>
    </changeSet>

    <changeSet id="complaint-14-add-close-complaint-request-table" author="dmiller">
        <createTable tableName="acm_close_complaint_request">
            <column name="cm_close_complaint_id" type="${idType}" autoIncrement="${autoIncrement}">
                <constraints primaryKeyName="pk_close_complaint_request" primaryKey="true"/>
            </column>
            <column name="cm_complaint_id" type="${fkIdType}">
                <constraints nullable="false"/>
            </column>
            <column name="cm_disposition_id" type="${fkIdType}">
                <constraints nullable="false"/>
            </column>
            <column name="cm_close_complaint_status" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_close_complaint_created" type="${timestampType}">
                <constraints nullable="false"/>
            </column>
            <column name="cm_close_complaint_creator" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_close_complaint_modified" type="${timestampType}">
                <constraints nullable="false"/>
            </column>
            <column name="cm_close_complaint_modifier" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="acm_close_complaint_request" baseColumnNames="cm_complaint_id"
                                 constraintName="fk_close_complaint_cmplnt_id"
                                 referencedTableName="acm_complaint"
                                 referencedColumnNames="cm_complaint_id"
                                 deferrable="${deferrable}"
                                 initiallyDeferred="${initially.deferred}"/>
    </changeSet>
    
    <changeSet id="complaint-15-change-location-to-address-id" author="riste.tutureski">
    	<dropColumn tableName="acm_complaint" columnName="cm_location"/>
    	<addColumn tableName="acm_complaint">
    		<column name="cm_address_id" type="${fkIdType}"/>
    	</addColumn>
    </changeSet>

    <changeSet id="complaint-16-add-restricted-flag" author="dmiller">
        <addColumn tableName="acm_complaint">
            <column name="cm_complaint_restricted_flag" type="VARCHAR(32)" defaultValue="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="complaint-17-add-container-folder-id" author="dmiller">
        <addColumn tableName="acm_complaint">
            <column name="cm_container_folder_id" type="${fkIdType}"/>
        </addColumn>
    </changeSet>

    <changeSet id="complaint-18-rename-container-id" author="dmiller">
        <renameColumn tableName="acm_complaint" oldColumnName="cm_container_folder_id" newColumnName="cm_container_id" columnDataType="${fkIdType}"/>
    </changeSet>

    <changeSet id="19-object-type-in-acm-complaint-table" author="nebojsha.davidovikj">
        <addColumn tableName="acm_complaint">
            <column name="cm_object_type" type="VARCHAR(100)" defaultValue="COMPLAINT">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="20-object-type-in-acm-close-complaint-request-table" author="nebojsha.davidovikj">
        <addColumn tableName="acm_close_complaint_request">
            <column name="cm_object_type" type="VARCHAR(100)" defaultValue="CLOSE_COMPLAINT_REQUEST">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

</databaseChangeLog>

