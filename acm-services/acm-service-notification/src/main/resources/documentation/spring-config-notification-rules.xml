<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:task="http://www.springframework.org/schema/task"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.1.xsd
       http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task-4.1.xsd">

	<import resource="file:${user.home}/.acm/app-config.xml" />

	<!-- Rules definitions -->
	<bean id="assignRule"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="sendExecutor" />
		<property name="jpaQuery">
			<value>
				<![CDATA[
					SELECT 
					  a.newAssignee AS user,
					  CONCAT('${objectTypeLabel} ', a.objectName, ' assigned to ', u.fullName, ' on ', a.created) AS title,
					  CONCAT('${objectTypeLabel} ', a.objectName, ' was assigned to ', u.fullName, ' on ', a.created, '.  Click here to view: ${urlanchor}') AS note,
					  'user' AS notificationType,
					  a.objectId AS objectId,
					  a.objectType AS objectType,
					  a.objectName AS objectName,
					  a.objectTitle AS objectTitle,
					  u.mail as mail
					FROM 
						AcmAssignment a, AcmUser u 
					WHERE 
						a.newAssignee IS NOT NULL 
					AND
						a.newAssignee=u.userId 
					AND 
						a.created >= :lastRunDate
					ORDER BY 
						a.created
				]]>
			</value>
		</property>
	</bean>

	<bean id="unassignRule"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="sendExecutor" />
		<property name="jpaQuery">
			<value>
				<![CDATA[
					SELECT 	
					  a.oldAssignee AS user,
					  CONCAT('${objectTypeLabel} ', a.objectName, ' unassigned from ', u.fullName, ' on ', a.created) AS title,
					  CONCAT('${objectTypeLabel} ', a.objectName, ' was unassigned from ', u.fullName, ' on ', a.created, '.  Click here to view: ${urlanchor}') AS note,
					  'user' AS notificationType,
					  a.objectId AS objectId,
					  a.objectType AS objectType,
					  a.objectName AS objectName,
					  a.objectTitle AS objectTitle,
					  u.mail as mail
					FROM 
						AcmAssignment a, AcmUser u 
					WHERE 
						a.oldAssignee IS NOT NULL
					AND
						a.oldAssignee=u.userId 
					AND 
						a.created >= :lastRunDate
					ORDER BY 
						a.created
				]]>
			</value>
		</property>
	</bean>

	<bean id="lodgeRuleUser"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="noopExecutor" />
		<property name="jpaQuery">
			<value>
				<![CDATA[
					SELECT
					  a.userId AS user,
					  CONCAT('Document(s) lodged in ${objectTypeLabel} ', cf.caseNumber, ' on ', a.eventDate) AS title,
					  CONCAT('Document(s) lodged in ${objectTypeLabel} ', cf.caseNumber, ' on ', a.eventDate, '.  Link: ${urlanchor}') AS note,
					  'user' AS notificationType,
					  a.objectId AS objectId,
					  a.objectType AS objectType,
					  cf.caseNumber AS objectName,
					  cf.title AS objectTitle,
					  u.mail as mail
					FROM
						AuditEvent a, CaseFile cf, AcmUser u
					WHERE
						a.userId = u.userId
					AND
					    a.fullEventType = 'com.armedia.acm.casefile.file.lodged'
					AND
						a.objectType = 'CASE_FILE'
					AND
						a.objectId = cf.id
					AND
						a.eventDate >= :lastRunDate
					ORDER BY
						a.eventDate
				]]>
			</value>
		</property>
	</bean>

	<bean id="lodgeRuleUserCaseParticipants"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="noopExecutor" />
		<property name="jpaQuery">
			<value>
				<![CDATA[
					SELECT
					  u.userId AS user,
					  CONCAT('Document(s) lodged in ${objectTypeLabel} ', cf.caseNumber, ' on ', a.eventDate) AS title,
					  CONCAT('Document(s) lodged in ${objectTypeLabel} ', cf.caseNumber, ' on ', a.eventDate, '.  Link: ${urlanchor}') AS note,
					  'user' AS notificationType,
					  a.objectId AS objectId,
					  a.objectType AS objectType,
					  cf.caseNumber AS objectName,
					  cf.title AS objectTitle,
					  u.mail as mail
					FROM
						AuditEvent a, CaseFile cf, AcmUser u, AcmParticipant ap
					WHERE
						a.eventDate >= :lastRunDate
					AND
						a.fullEventType = 'com.armedia.acm.casefile.file.lodged'
					AND
						a.objectType = 'CASE_FILE'
					AND
						a.objectId = cf.id
					AND
					    a.objectType = ap.objectType
					AND
					    a.objectId = ap.objectId
					AND
						ap.participantLdapId <> a.userId
					AND
						ap.participantLdapId <> '*'
					AND
						ap.participantType <> 'No Access'
					AND
						ap.participantLdapId = u.userId
					ORDER BY
						a.eventDate
				]]>
			</value>
		</property>
	</bean>

	<bean id="lodgeRuleGroupCaseParticipants"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="noopExecutor" />
		<property name="jpaQuery">
			<value>
				<![CDATA[
					SELECT DISTINCT
					  u.userId AS user,
					  CONCAT('Document(s) lodged in ${objectTypeLabel} ', cf.caseNumber, ' on ', a.eventDate) AS title,
					  CONCAT('Document(s) lodged in ${objectTypeLabel} ', cf.caseNumber, ' on ', a.eventDate, '.  Link: ${urlanchor}') AS note,
					  'user' AS notificationType,
					  a.objectId AS objectId,
					  a.objectType AS objectType,
					  cf.caseNumber AS objectName,
					  cf.title AS objectTitle,
					  u.mail as mail
					FROM
						AuditEvent a, CaseFile cf, AcmUser u, AcmParticipant ap, AcmGroup ag
					WHERE
						a.eventDate >= :lastRunDate
					AND
						a.fullEventType = 'com.armedia.acm.casefile.file.lodged'
					AND
						a.objectType = 'CASE_FILE'
					AND
						a.objectId = cf.id
					AND
					    a.objectType = ap.objectType
					AND
					    a.objectId = ap.objectId
					AND
						ap.participantLdapId <> '*'
					AND
						ap.participantType <> 'No Access'
					AND
						ap.participantLdapId = ag.name
					AND
						u MEMBER OF ag.members
					AND
					    u.userId <> a.userId
					AND
					    u.userId NOT IN (
					      SELECT iap.participantLdapId
					      FROM   AcmParticipant iap
					      WHERE  iap.objectType = a.objectType
					      AND    iap.objectId = a.objectId )
					ORDER BY
						a.eventDate
				]]>
			</value>
		</property>
	</bean>

	<bean id="rejectRule"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="noopExecutor" />
		<property name="jpaQuery">
			<value>
				<![CDATA[
					SELECT
					  a.userId AS user,
					  CONCAT('Document(s) rejected in ${objectTypeLabel} ', cf.caseNumber, ' on ', a.eventDate) AS title,
					  CONCAT('Document(s) rejected in ${objectTypeLabel} ', cf.caseNumber, ' on ', a.eventDate, '.  Link: ${urlanchor}') AS note,
					  'user' AS notificationType,
					  a.objectId AS objectId,
					  a.objectType AS objectType,
					  cf.caseNumber AS objectName,
					  cf.title AS objectTitle,
					  u.mail as mail
					FROM
						AuditEvent a, CaseFile cf, AcmUser u
					WHERE
						a.userId = u.userId
					AND
					    a.fullEventType = 'com.armedia.acm.casefile.file.rejected'
					AND
						a.objectType = 'CASE_FILE'
					AND
						a.objectId = cf.id
					AND
						a.eventDate >= :lastRunDate
					ORDER BY
						a.eventDate
				]]>
			</value>
		</property>
	</bean>

	<bean id="rejectRuleUserCaseParticipants"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="noopExecutor" />
		<property name="jpaQuery">
			<value>
				<![CDATA[
					SELECT
					  u.userId AS user,
					  CONCAT('Document(s) rejected in ${objectTypeLabel} ', cf.caseNumber, ' on ', a.eventDate) AS title,
					  CONCAT('Document(s) rejected in ${objectTypeLabel} ', cf.caseNumber, ' on ', a.eventDate, '.  Link: ${urlanchor}') AS note,
					  'user' AS notificationType,
					  a.objectId AS objectId,
					  a.objectType AS objectType,
					  cf.caseNumber AS objectName,
					  cf.title AS objectTitle,
					  u.mail as mail
					FROM
						AuditEvent a, CaseFile cf, AcmUser u, AcmParticipant ap
					WHERE
						a.eventDate >= :lastRunDate
					AND
						a.fullEventType = 'com.armedia.acm.casefile.file.rejected'
					AND
						a.objectType = 'CASE_FILE'
					AND
						a.objectId = cf.id
					AND
					    a.objectType = ap.objectType
					AND
					    a.objectId = ap.objectId
					AND
						ap.participantLdapId <> a.userId
					AND
						ap.participantLdapId <> '*'
					AND
						ap.participantType <> 'No Access'
					AND
						ap.participantLdapId = u.userId
					ORDER BY
						a.eventDate
				]]>
			</value>
		</property>
	</bean>

	<bean id="rejectRuleGroupCaseParticipants"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="noopExecutor" />
		<property name="jpaQuery">
			<value>
				<![CDATA[
					SELECT DISTINCT
					  u.userId AS user,
					  CONCAT('Document(s) rejected in ${objectTypeLabel} ', cf.caseNumber, ' on ', a.eventDate) AS title,
					  CONCAT('Document(s) rejected in ${objectTypeLabel} ', cf.caseNumber, ' on ', a.eventDate, '.  Link: ${urlanchor}') AS note,
					  'user' AS notificationType,
					  a.objectId AS objectId,
					  a.objectType AS objectType,
					  cf.caseNumber AS objectName,
					  cf.title AS objectTitle,
					  u.mail as mail
					FROM
						AuditEvent a, CaseFile cf, AcmUser u, AcmParticipant ap, AcmGroup ag
					WHERE
						a.eventDate >= :lastRunDate
					AND
						a.fullEventType = 'com.armedia.acm.casefile.file.rejected'
					AND
						a.objectType = 'CASE_FILE'
					AND
						a.objectId = cf.id
					AND
					    a.objectType = ap.objectType
					AND
					    a.objectId = ap.objectId
					AND
						ap.participantLdapId <> '*'
					AND
						ap.participantType <> 'No Access'
					AND
						ap.participantLdapId = ag.name
					AND
						u MEMBER OF ag.members
					AND
					    u.userId <> a.userId
					AND
					    u.userId NOT IN (
					      SELECT iap.participantLdapId
					      FROM   AcmParticipant iap
					      WHERE  iap.objectType = a.objectType
					      AND    iap.objectId = a.objectId )
					ORDER BY
						a.eventDate
				]]>
			</value>
		</property>
	</bean>

	<bean id="purgeRule"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="SELECT" />
		<property name="executor" ref="purgeExecutor" />
		<property name="jpaQuery">
			<value>
				<![CDATA[
					SELECT 
					    notification
					FROM 
						Notification notification 
					WHERE 
						notification.status != 'DELETE' 
					AND
						notification.created <= :threshold
				]]>
			</value>
		</property>
	</bean>

	<bean id="documentCreatedRule"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="noopExecutor" />
		<property name="jpaQuery">
			<value>
				<![CDATA[
					SELECT
					  u.userId AS user,
					  CONCAT('Document(s) created in ${objectTypeLabel} ', ecmf.fileName, ' on ', a.eventDate) AS title,
					  CONCAT('Document(s) created in ${objectTypeLabel} ', ecmf.fileName, ' on ', a.eventDate, '.  Link: ${urlanchor}') AS note,
					  'user' AS notificationType,
					  a.objectId AS objectId,
					  a.objectType AS objectType,
					  ecmf.fileName AS objectName,
					  ecmf.fileName AS objectTitle,
					  u.mail as mail
					FROM
						AuditEvent a, EcmFile ecmf, AcmUser u
					WHERE
						a.userId = u.userId
					AND
						a.eventDate >= :lastRunDate
					AND
						a.fullEventType = 'com.armedia.acm.ecm.file.added'
					AND
						a.objectType = 'FILE'
					AND
						a.objectId = ecmf.fileId
					ORDER BY
						a.eventDate
				]]>
			</value>
		</property>
	</bean>

	<bean id="documentDeletedRule"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="noopExecutor" />
		<property name="jpaQuery">
			<value>
                <![CDATA[
                  SELECT
                      u.userId AS user,
                      CONCAT('Document(s) deleted in ${objectTypeLabel} on ', a.eventDate) AS title,
                      CONCAT('Document(s) deleted in ${objectTypeLabel} on ', a.eventDate, '.  Link: ${urlanchor}') AS note,
                      'user' AS notificationType,
                      a.objectId AS objectId,
                      a.objectType AS objectType,
                      'deleted_file_name' AS objectName,
                      'deleted_file_name' AS objectTitle,
                      u.mail as mail
                    FROM
                        AuditEvent a, AcmUser u
                    WHERE
                        a.userId = u.userId
                    AND
                        a.eventDate >= :lastRunDate
                    AND
                        a.fullEventType = 'com.armedia.acm.file.deleted'
                    AND
                        a.objectType = 'FILE'
                    AND 
                        a.eventResult = 'success'
                    ORDER BY
                        a.eventDate
                ]]>
			</value>
		</property>
	</bean>

	<bean id="documentReplacedRule"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="noopExecutor" />
		<property name="jpaQuery">
			<value>
                <![CDATA[
                    SELECT
                      u.userId AS user,
                      CONCAT('Document(s) ', ecmf.fileName, ' replaced in ${objectTypeLabel} on ', a.eventDate) AS title,
                      CONCAT('Document(s) ', ecmf.fileName, ' replaced in ${objectTypeLabel} on ', a.eventDate, '.  Link: ${urlanchor}') AS note,
                      'user' AS notificationType,
                      a.objectId AS objectId,
                      a.objectType AS objectType,
                      ecmf.fileName AS objectName,
                      ecmf.fileName AS objectTitle,
                      u.mail as mail
                    FROM
                         AuditEvent a, EcmFile ecmf, AcmUser u
                    WHERE
                        a.userId = u.userId
                    AND
                        a.eventDate >= :lastRunDate
                    AND
                        a.fullEventType = 'com.armedia.acm.ecm.file.replaced'
                    AND
                        a.objectType = 'FILE'
                    AND
                        a.objectId = ecmf.fileId
                    ORDER BY
                        a.eventDate

                ]]>
			</value>
		</property>
	</bean>

	<bean id="documentVersionedRule"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="noopExecutor" />
		<property name="jpaQuery">
			<value>
                <![CDATA[
                    SELECT u.userId AS user,
                    CONCAT('Document(s) ', ecmf.fileName, ' versioned in ${objectTypeLabel} on ', a.eventDate) AS title,
                    CONCAT('Document(s) ', ecmf.fileName, ' versioned in ${objectTypeLabel} on ', a.eventDate, '.  Link: ${urlanchor}') AS note,
                    'user' AS notificationType,
                    a.objectId AS objectId,
                    a.objectType AS objectType,
                    ecmf.fileName AS objectName,
                    ecmf.fileName AS objectTitle,
                    u.mail as mail
                    FROM 
                    AuditEvent a, EcmFile ecmf, AcmUser u
                    WHERE 
                    a.userId = u.userId
                    AND 
                    a.eventDate >= :lastRunDate
                    AND 
                    a.fullEventType = 'com.armedia.acm.file.version.set'
                    AND 
                    a.objectType = 'FILE'
                    AND
                    a.objectId = ecmf.fileId
                    ORDER BY 
                    a.eventDate
                ]]>
			</value>
		</property>
	</bean>

	<bean id="complaintStatusChangedRule"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="noopExecutor" />
		<property name="jpaQuery">
			<value>
                <![CDATA[
                    SELECT u.userId AS user,
                    CONCAT('Complaint ', c.complaintNumber, ' status changed on ', a.eventDate) AS title,
                    CONCAT('Complaint ', c.complaintNumber, ' status changed on ', a.eventDate, '.  Link: ${urlanchor}') AS note,
                    'user' AS notificationType,
                    a.objectId AS objectId,
                    a.objectType AS objectType,
                    c.complaintNumber AS objectName,
                    c.complaintTitle AS objectTitle,
                    u.mail as mail
                    FROM 
                    AuditEvent a, Complaint c, AcmUser u
                    WHERE 
                    a.userId = u.userId
                    AND 
                    a.eventDate >= :lastRunDate
                    AND 
                    a.fullEventType = 'com.armedia.acm.complaint.status.updated'
                    AND 
                    a.objectType = 'COMPLAINT'
                    AND
                    a.objectId = c.complaintId
                    ORDER BY 
                    a.eventDate
                ]]>
			</value>
		</property>
	</bean>

	<bean id="caseStatusChangedRule"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="noopExecutor" />
		<property name="jpaQuery">
			<value>
                <![CDATA[
                    SELECT u.userId AS user,
                    CONCAT('Case ', c.caseNumber, ' status changed on ', a.eventDate) AS title,
                    CONCAT('Case ', c.caseNumber, ' status changed on ', a.eventDate, '.  Link: ${urlanchor}') AS note,
                    'user' AS notificationType,
                    a.objectId AS objectId,
                    a.objectType AS objectType,
                    c.caseNumber AS objectName,
                    c.title AS objectTitle,
                    u.mail as mail
                    FROM 
                    AuditEvent a, CaseFile c, AcmUser u
                    WHERE 
                    a.userId = u.userId
                    AND 
                    a.eventDate >= :lastRunDate
                    AND 
                    a.fullEventType = 'com.armedia.acm.casefile.status.changed'
                    AND 
                    a.objectType = 'CASE_FILE'
                    AND
                    a.objectId = c.id
                    ORDER BY 
                    a.eventDate
                ]]>
			</value>
		</property>
	</bean>

	<bean id="noteAddedRule"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="noopExecutor" />
		<property name="jpaQuery">
			<value>
                <![CDATA[
                    SELECT u.userId AS user,
                    CONCAT('Notification added in ', n.parentType, ' on ', a.eventDate) AS title,
                    CONCAT('Notification added in ', n.parentType, ' on ', a.eventDate, '.  Link: ${urlanchor}') AS note,
                    'user' AS notificationType,
                    a.objectId AS objectId,
                    a.objectType AS objectType,
                    'note' AS objectName,
                    'note' AS objectTitle,
                    u.mail as mail
                    FROM 
                    AuditEvent a, Note n, AcmUser u
                    WHERE 
                    a.userId = u.userId
                    AND 
                    a.eventDate >= :lastRunDate
                    AND 
                    a.fullEventType = 'note'
                    AND 
                    a.objectType = 'NOTIFICATION'
                    AND
                    a.objectId = n.id
                    ORDER BY 
                    a.eventDate
                ]]>
			</value>
		</property>
	</bean>

	<bean id="complaintPriorityUpdatedRule"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="noopExecutor" />
		<property name="jpaQuery">
			<value>
                <![CDATA[
                    SELECT u.userId AS user,
                    CONCAT('Complaint ', c.complaintNumber , ' priority updated on ', a.eventDate) AS title,
                    CONCAT('Complaint ', c.complaintNumber , ' priority updated on ', a.eventDate, '.  Link: ${urlanchor}') AS note,
                    'user' AS notificationType,
                    a.objectId AS objectId,
                    a.objectType AS objectType,
                    c.complaintNumber AS objectName,
                    c.complaintTitle AS objectTitle,
                    u.mail as mail
                    FROM 
                    AuditEvent a, Complaint c, AcmUser u
                    WHERE 
                    a.userId = u.userId
                    AND 
                    a.eventDate >= :lastRunDate
                    AND 
                    a.fullEventType = 'com.armedia.acm.complaint.priority.changed'
                    AND 
                    a.objectType = 'COMPLAINT'
                    AND
                    a.objectId = c.complaintId
                    ORDER BY 
                    a.eventDate
                ]]>
			</value>
		</property>
	</bean>

	<bean id="complaintDetailsUpdatedRule"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="noopExecutor" />
		<property name="jpaQuery">
			<value>
                <![CDATA[
                    SELECT u.userId AS user,
                    CONCAT('Complaint ', c.complaintNumber , ' details updated on ', a.eventDate) AS title,
                    CONCAT('Complaint ', c.complaintNumber , ' details updated on ', a.eventDate, '.  Link: ${urlanchor}') AS note,
                    'user' AS notificationType,
                    a.objectId AS objectId,
                    a.objectType AS objectType,
                    c.complaintNumber AS objectName,
                    c.complaintTitle AS objectTitle,
                    u.mail as mail
                    FROM 
                    AuditEvent a, Complaint c, AcmUser u
                    WHERE 
                    a.userId = u.userId
                    AND 
                    a.eventDate >= :lastRunDate
                    AND 
                    a.fullEventType = 'com.armedia.acm.complaint.details.changed'
                    AND 
                    a.objectType = 'COMPLAINT'
                    AND
                    a.objectId = c.complaintId
                    ORDER BY 
                    a.eventDate
                ]]>
			</value>
		</property>
	</bean>

	<bean id="caseFilePriorityUpdatedRule"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="noopExecutor" />
		<property name="jpaQuery">
			<value>
                <![CDATA[
                    SELECT u.userId AS user,
                    CONCAT('Case file ', c.caseNumber , ' priority updated on ', a.eventDate) AS title,
                    CONCAT('Case file ', c.caseNumber , ' priority updated on ', a.eventDate, '.  Link: ${urlanchor}') AS note,
                    'user' AS notificationType,
                    a.objectId AS objectId,
                    a.objectType AS objectType,
                    c.caseNumber AS objectName,
                    c.title AS objectTitle,
                    u.mail as mail
                    FROM 
                    AuditEvent a, CaseFile c, AcmUser u
                    WHERE 
                    a.userId = u.userId
                    AND 
                    a.eventDate >= :lastRunDate
                    AND 
                    a.fullEventType = 'com.armedia.acm.casefile.priority.changed'
                    AND 
                    a.objectType = 'CASE_FILE'
                    AND
                    a.objectId = c.id
                    ORDER BY 
                    a.eventDate
                ]]>
			</value>
		</property>
	</bean>

	<bean id="caseFileDetailsUpdatedRule"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="noopExecutor" />
		<property name="jpaQuery">
			<value>
                <![CDATA[
                    SELECT u.userId AS user,
                    CONCAT('Case file ', c.caseNumber , ' details updated on ', a.eventDate) AS title,
                    CONCAT('Case file ', c.caseNumber , ' details updated on ', a.eventDate, '.  Link: ${urlanchor}') AS note,
                    'user' AS notificationType,
                    a.objectId AS objectId,
                    a.objectType AS objectType,
                    c.caseNumber AS objectName,
                    c.title AS objectTitle,
                    u.mail as mail
                    FROM 
                    AuditEvent a, CaseFile c, AcmUser u
                    WHERE 
                    a.userId = u.userId
                    AND 
                    a.eventDate >= :lastRunDate
                    AND 
                    a.fullEventType = 'com.armedia.acm.casefile.details.changed'
                    AND 
                    a.objectType = 'CASE_FILE'
                    AND
                    a.objectId = c.id
                    ORDER BY 
                    a.eventDate
                ]]>
			</value>
		</property>
	</bean>

	<bean id="personAssociationAddedRule"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="noopExecutor" />
		<property name="jpaQuery">
			<value>
                <![CDATA[
                    SELECT u.userId AS user,
                    CONCAT('Person added in ', p.parentType, ' on ', a.eventDate) AS title,
                    CONCAT('Person added in ', p.parentType, ' on ', a.eventDate, '.  Link: ${urlanchor}') AS note,
                    'user' AS notificationType,
                    a.objectId AS objectId,
                    a.objectType AS objectType,
                    'person' AS objectName,
                    'person' AS objectTitle,
                    u.mail as mail
                    FROM 
                    AuditEvent a, PersonAssociation p, AcmUser u
                    WHERE 
                    a.userId = u.userId
                    AND 
                    a.eventDate >= :lastRunDate
                    AND 
                    a.fullEventType = 'com.armedia.acm.personAssociation.created'
                    AND 
                    a.objectType = 'PERSON-ASSOCIATION'
                    AND
                    a.objectId = p.id
                    ORDER BY 
                    a.eventDate
                ]]>
			</value>
		</property>
	</bean>

	<bean id="personAssociationDeletedRule"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="noopExecutor" />
		<property name="jpaQuery">
			<value>
                <![CDATA[
                    SELECT u.userId AS user,
                    CONCAT('Person deleted on ', a.eventDate) AS title,
                    CONCAT('Person deleted on ', a.eventDate, '.  Link: ${urlanchor}') AS note,
                    'user' AS notificationType,
                    a.objectId AS objectId,
                    a.objectType AS objectType,
                    'person' AS objectName,
                    'person' AS objectTitle,
                    u.mail as mail
                    FROM 
                    AuditEvent a, PersonAssociation p, AcmUser u
                    WHERE 
                    a.userId = u.userId
                    AND 
                    a.eventDate >= :lastRunDate
                    AND 
                    a.fullEventType = 'com.armedia.acm.personAssociation.deleted'
                    AND 
                    a.objectType = 'PERSON-ASSOCIATION'
                    ORDER BY 
                    a.eventDate
                ]]>
			</value>
		</property>
	</bean>

	<bean id="participantsAddedInComplaintRule"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="noopExecutor" />
		<property name="jpaQuery">
			<value>
                <![CDATA[
                    SELECT DISTINCT u.userId, a.eventDate AS user,
                    CONCAT('Participants added in ', p.objectType, ' on ', a.eventDate) AS title,
                    CONCAT('Participants added in ', p.objectType, ' on ', a.eventDate, '.  Link: ${urlanchor}') AS note,
                    'user' AS notificationType,
                    a.objectId AS objectId,
                    a.objectType AS objectType,
                    'participant' AS objectName,
                    'participant' AS objectTitle,
                    u.mail as mail
                    FROM 
                    AuditEvent a, AcmParticipant p, AcmUser u
                    WHERE 
                    a.userId = u.userId
                    AND 
                    a.eventDate >= :lastRunDate
                    AND 
                    a.fullEventType = 'com.armedia.acm.complaint.participants.added'
                    AND
                    a.objectId = p.objectId
                    AND
                    a.objectType = p.objectType
                    ORDER BY 
                    a.eventDate
                ]]>
			</value>
		</property>
	</bean>

	<bean id="participantsDeletedInComplaintRule"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="noopExecutor" />
		<property name="jpaQuery">
			<value>
                <![CDATA[
                    SELECT u.userId AS user,
                    CONCAT('Participants deleted in ', a.objectType, ' on ', a.eventDate) AS title,
                    CONCAT('Participants deleted in ', a.objectType, ' on ', a.eventDate, '.  Link: ${urlanchor}') AS note,
                    'user' AS notificationType,
                    a.objectId AS objectId,
                    a.objectType AS objectType,
                    'participant' AS objectName,
                    'participant' AS objectTitle,
                    u.mail as mail
                    FROM 
                    AuditEvent a, AcmUser u
                    WHERE 
                    a.userId = u.userId
                    AND 
                    a.eventDate >= :lastRunDate
                    AND 
                    a.fullEventType = 'com.armedia.acm.complaint.participants.deleted'
                    ORDER BY 
                    a.eventDate
                ]]>
			</value>
		</property>
	</bean>

	<bean id="participantsAddedInCaseFileRule"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="noopExecutor" />
		<property name="jpaQuery">
			<value>
                <![CDATA[
                    SELECT DISTINCT u.userId, a.eventDate AS user,
                    CONCAT('Participants added in ', p.objectType, ' on ', a.eventDate) AS title,
                    CONCAT('Participants added in ', p.objectType, ' on ', a.eventDate, '.  Link: ${urlanchor}') AS note,
                    'user' AS notificationType,
                    a.objectId AS objectId,
                    a.objectType AS objectType,
                    'participant' AS objectName,
                    'participant' AS objectTitle,
                    u.mail as mail
                    FROM 
                    AuditEvent a, AcmParticipant p, AcmUser u
                    WHERE 
                    a.userId = u.userId
                    AND 
                    a.eventDate >= :lastRunDate
                    AND 
                    a.fullEventType = 'com.armedia.acm.casefile.participants.added'
                    AND
                    a.objectId = p.objectId
                    AND
                    a.objectType = p.objectType
                    ORDER BY 
                    a.eventDate
                ]]>
			</value>
		</property>
	</bean>

	<bean id="participantsDeletedInCaseFileRule"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="noopExecutor" />
		<property name="jpaQuery">
			<value>
                <![CDATA[
                    SELECT u.userId AS user,
                    CONCAT('Participants deleted in ', a.objectType, ' on ', a.eventDate) AS title,
                    CONCAT('Participants deleted in ', a.objectType, ' on ', a.eventDate, '.  Link: ${urlanchor}') AS note,
                    'user' AS notificationType,
                    a.objectId AS objectId,
                    a.objectType AS objectType,
                    'participant' AS objectName,
                    'participant' AS objectTitle,
                    u.mail as mail
                    FROM 
                    AuditEvent a, AcmUser u
                    WHERE 
                    a.userId = u.userId
                    AND 
                    a.eventDate >= :lastRunDate
                    AND 
                    a.fullEventType = 'com.armedia.acm.casefile.participants.added'
                    ORDER BY 
                    a.eventDate
                ]]>
			</value>
		</property>
	</bean>


	<bean id="calendarEventAddedRule"
		class="com.armedia.acm.services.notification.model.BasicNotificationRule">
		<property name="globalRule" value="true" />
		<property name="queryType" value="CREATE" />
		<property name="executor" ref="noopExecutor" />
		<property name="jpaQuery">
			<value>
                <![CDATA[
                    SELECT u.userId AS user,
                    CONCAT('Calendar event added on ', a.eventDate) AS title,
                    CONCAT('Calendar event added on ', a.eventDate, '.  Link: ${urlanchor}') AS note,
                    'user' AS notificationType,
                    'eventId' AS objectId,
                    a.objectType AS objectType,
                    'OutlookItem' AS objectName,
                    'event' AS objectTitle,
                    u.mail as mail
                    FROM 
                    AuditEvent a, AcmUser u
                    WHERE 
                    a.userId = u.userId
                    AND 
                    a.eventDate >= :lastRunDate
                    AND 
                    a.fullEventType = 'com.armedia.acm.outlook.calendar.added'
                    AND
                    a.objectType = 'CALENDAR_ITEM'
                    ORDER BY 
                    a.eventDate
                ]]>
			</value>
		</property>
	</bean>

	<!-- Senders Definition -->
	<bean id="emailNotificationSender"
		class="com.armedia.acm.services.notification.service.EmailNotificationSender">
		<property name="auditPropertyEntityAdapter" ref="auditPropertyEntityAdapter" />
		<property name="propertyFileManager">
			<bean class="com.armedia.acm.files.propertymanager.PropertyFileManager" />
		</property>
		<property name="notificationPropertyFileLocation" ref="notificationPropertyFileLocation" />
		<property name="muleContextManager" ref="muleContextManager" />
	</bean>

	<!-- Task Scheduler -->
	<task:scheduler id="notificationTaskScheduler"
		pool-size="1" />
	<task:scheduled-tasks scheduler="notificationTaskScheduler">
		<task:scheduled ref="notificationService" method="run"
			fixed-delay="300000" />
	</task:scheduled-tasks>

	<!-- Service Definition -->
	<bean id="notificationFormatter"
		class="com.armedia.acm.services.notification.service.NotificationFormatter">
		<property name="notificationProperties" ref="notificationProperties" />
		<property name="acmAppConfiguration" ref="acmApplication" />
	</bean>
	<bean id="notificationService"
		class="com.armedia.acm.services.notification.service.NotificationServiceImpl">
		<property name="batchRun" ref="notificationUserBatchRun" />
		<property name="batchSize" ref="notificationUserBatchSize" />
		<property name="purgeDays" ref="notificationPurgeDays" />
		<property name="propertyFileManager">
			<bean class="com.armedia.acm.files.propertymanager.PropertyFileManager" />
		</property>
		<property name="notificationPropertyFileLocation" ref="notificationPropertyFileLocation" />
		<property name="notificationDao" ref="notificationDao" />
		<property name="notificationEventPublisher" ref="notificationEventPublisher" />
		<property name="springContextHolder" ref="acmContextHolder" />
		<property name="auditPropertyEntityAdapter" ref="auditPropertyEntityAdapter" />
		<property name="notificationFormatter" ref="notificationFormatter" />
	</bean>

</beans>
