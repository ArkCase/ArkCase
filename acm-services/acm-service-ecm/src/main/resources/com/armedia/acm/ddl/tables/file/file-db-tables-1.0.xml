<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
            http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <property  name="timestampFunction" value="SYSTIMESTAMP" dbms="oracle"/>
    <property  name="timestampFunction" value="localtimestamp" dbms="postgresql"/>

    <property name="defaultValueComputedFunction" value="SYS_GUID()" dbms="oracle"/>
    <property name="defaultValueComputedFunction" value="nextVal('SEQ_GEN_IDENTITY')" dbms="postgresql"/>

    <property name="idType" value="NUMBER(32,0)" dbms="oracle"/>
    <property name="idType" value="BIGINT" dbms="mysql"/>
    <property name="idType" value="BIGSERIAL" dbms="postgresql"/>

    <property name="nextValFromSequence" value="seq_gen_identity.nextval" dbms="oracle"/>
    <property name="nextValFromSequence" value="nextVal('SEQ_GEN_IDENTITY')" dbms="postgresql"/>

    <property name="initially.deferred" value="true" dbms="postgresql,oracle"/>
    <property name="initially.deferred" value="false" dbms="mysql"/>

    <property name="deferrable" value="true" dbms="postgresql,oracle"/>
    <property name="deferrable" value="false" dbms="mysql"/>

    <property name="timestampType" value="TIMESTAMP WITH TIME ZONE" dbms="oracle,postgresql"/>
    <property name="timestampType" value="TIMESTAMP" dbms="mysql"/>

    <property name="autoIncrement" value="false" dbms="oracle,postgresql"/>
    <property name="autoIncrement" value="true" dbms="mysql"/>

    <property name="cmObjectTypeLength" value="1024" dbms="postgresql,oracle"/>
    <property name="cmObjectTypeLength" value="255" dbms="mysql"/>

    <property name="cmFileEcmIdLength" value="4000" dbms="postgresql,oracle"/>
    <property name="cmFileEcmIdLength" value="255" dbms="mysql"/>

    <property name="cmCmisFolderIdLength" value="1024" dbms="postgresql,oracle"/>
    <property name="cmCmisFolderIdLength" value="255" dbms="mysql"/>

    <property name="cmVersionSeriesIdLength" value="4000" dbms="postgresql,oracle"/>
    <property name="cmVersionSeriesIdLength" value="255" dbms="mysql"/>

    <property name="initially.deferred" value="true" dbms="postgresql,oracle"/>
    <property name="initially.deferred" value="false" dbms="mysql"/>

    <property name="deferrable" value="true" dbms="postgresql,oracle"/>
    <property name="deferrable" value="false" dbms="mysql"/>

    <changeSet id="01-create-file-table" author="dmiller">
        <createTable tableName="acm_file">
            <column name="cm_file_id" type="${idType}" autoIncrement="${autoIncrement}">
                <constraints
                        primaryKey="true"
                        primaryKeyName="pk_file"/>
            </column>
            <column name="cm_file_status" type="VARCHAR(128)" defaultValue="ACTIVE">
                <constraints nullable="false"/>
            </column>
            <column name="cm_file_created" type="${timestampType}">
                <constraints nullable="false"/>
            </column>
            <column name="cm_file_creator" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_file_modified" type="${timestampType}">
                <constraints nullable="false"/>
            </column>
            <column name="cm_file_modifier" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_file_mime_type" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_file_ecm_id" type="VARCHAR(${cmFileEcmIdLength})">
                <constraints nullable="false" unique="true" uniqueConstraintName="uk_file_ecm_id"/>
            </column>
            <column name="cm_file_name" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
        </createTable>

    </changeSet>

    <changeSet id="02-file-switch-to-sequence-pk" author="dmiller">
        <dropDefaultValue tableName="acm_file" columnName="cm_file_id"/>
        <modifyDataType tableName="acm_file" columnName="cm_file_id" newDataType="${idType}"/>
    </changeSet>

    <changeSet id="files-03-add-file-type-column" author="dmiller">
        <addColumn tableName="acm_file">
            <column name="cm_file_type" type="VARCHAR(1024)"/>
        </addColumn>
    </changeSet>

    <changeSet id="files-05-container-folder-table" author="dmiller">
        <createTable tableName="acm_container_folder">
            <column name="cm_container_folder_id" type="${idType}">
                <constraints primaryKey="true" primaryKeyName="pk_container_folder"/>
            </column>
            <column name="cm_container_folder_created" type="${timestampType}">
                <constraints nullable="false"/>
            </column>
            <column name="cm_container_folder_creator" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_container_folder_modified" type="${timestampType}">
                <constraints nullable="false"/>
            </column>
            <column name="cm_container_folder_modifier" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_object_type" type="VARCHAR(${cmObjectTypeLength})">
                <constraints nullable="false"/>
            </column>
            <column name="cm_object_id" type="${idType}">
                <constraints nullable="false"/>
            </column>
            <column name="cm_cmis_folder_id" type="VARCHAR(${cmCmisFolderIdLength})">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addUniqueConstraint tableName="acm_container_folder" columnNames="cm_object_id, cm_object_type"/>
        <addUniqueConstraint tableName="acm_container_folder" columnNames="cm_cmis_folder_id"/>
    </changeSet>
    
    <changeSet id="files-09-rename-acm-container-folder" author="dmiller">
        <renameTable oldTableName="acm_container_folder" newTableName="acm_container"/>
    </changeSet>
    
    <changeSet id="files-10-add-acm-folder-table" author="dmiller">
        <createTable tableName="acm_folder">
            <column name="cm_folder_id" type="${idType}">
                <constraints primaryKey="true" primaryKeyName="pk_folder"/>
            </column>
            <column name="cm_folder_created" type="${timestampType}">
                <constraints nullable="false"/>
            </column>
            <column name="cm_folder_creator" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_folder_modified" type="${timestampType}">
                <constraints nullable="false"/>
            </column>
            <column name="cm_folder_modifier" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_cmis_folder_id" type="VARCHAR(${cmCmisFolderIdLength})">
                <constraints nullable="false"/>
            </column>
            <column name="cm_folder_name" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_parent_folder_id" type="${idType}">
                <constraints nullable="true"
                             foreignKeyName="fk_folder_parent_id"
                             referencedTableName="acm_folder"
                             referencedColumnNames="cm_folder_id"
                             initiallyDeferred="${initially.deferred}"
                             deferrable="${deferrable}"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="files-12-update-acm-container-structure" author="dmiller">
        <addColumn tableName="acm_container">
            <column name="cm_folder_id" type="${idType}">
                <constraints
                    foreignKeyName="fk_container_folder_id"
                    referencedTableName="acm_folder"
                    referencedColumnNames="cm_folder_id"
                    deferrable="${deferrable}"
                    initiallyDeferred="${initially.deferred}"/>
            </column>
        </addColumn>
        <renameColumn tableName="acm_container" oldColumnName="cm_container_folder_id" newColumnName="cm_container_id" columnDataType="${idType}"/>
        <renameColumn tableName="acm_container" oldColumnName="cm_container_folder_created" newColumnName="cm_container_created" columnDataType="${timestampType}"/>
        <renameColumn tableName="acm_container" oldColumnName="cm_container_folder_creator" newColumnName="cm_container_creator" columnDataType="VARCHAR(1024)"/>
        <renameColumn tableName="acm_container" oldColumnName="cm_container_folder_modified" newColumnName="cm_container_modified" columnDataType="${timestampType}"/>
        <renameColumn tableName="acm_container" oldColumnName="cm_container_folder_modifier" newColumnName="cm_container_modifier" columnDataType="VARCHAR(1024)"/>
        <dropPrimaryKey tableName="acm_container" constraintName="pk_container_folder"/>
        <addPrimaryKey tableName="acm_container" columnNames="cm_container_id" constraintName="pk_container"/>
    </changeSet>

    <changeSet id="files-14-make-container-folder-id-required" author="dmiller">
        <addNotNullConstraint tableName="acm_container" columnName="cm_folder_id" columnDataType="${idType}"/>
    </changeSet>

    <changeSet id="files-15-add-acm-file-version" author="dmiller">
        <createTable tableName="acm_file_version">
            <column name="cm_file_version_id" type="${idType}">
                <constraints primaryKey="true" primaryKeyName="pk_file_version"/>
            </column>
            <column name="cm_file_id" type="${idType}">
                <constraints nullable="false"
                             foreignKeyName="fk_file_version_file_id"
                             referencedTableName="acm_file"
                             referencedColumnNames="cm_file_id"
                             deferrable="${deferrable}"
                             initiallyDeferred="${initially.deferred}"/>
            </column>
            <column name="cm_file_version_created" type="${timestampType}">
                <constraints nullable="false"/>
            </column>
            <column name="cm_file_version_creator" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_file_version_modified" type="${timestampType}">
                <constraints nullable="false"/>
            </column>
            <column name="cm_file_version_modifier" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_file_version_version_tag" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="cm_cmis_object_id" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="files-17-update-acm-file-structure" author="dmiller">
        <renameColumn tableName="acm_file" oldColumnName="cm_file_ecm_id" newColumnName="cm_version_series_id" columnDataType="VARCHAR(${cmVersionSeriesIdLength})"/>
        <addColumn tableName="acm_file">
            <column name="cm_folder_id" type="${idType}">
                <constraints foreignKeyName="fk_file_folder_id"
                             referencedTableName="acm_folder"
                             referencedColumnNames="cm_folder_id"
                             deferrable="${deferrable}"
                             initiallyDeferred="${initially.deferred}"/>
            </column>
            <column name="cm_file_active_version_tag" type="VARCHAR(1024)" defaultValue="1.0">
                <constraints nullable="false"/>
            </column>
            <column name="cm_file_category" type="VARCHAR(128)"/>
        </addColumn>
        <dropUniqueConstraint tableName="acm_file" constraintName="uk_file_ecm_id"/>
        <addUniqueConstraint tableName="acm_file" columnNames="cm_version_series_id" constraintName="uk_version_series_id"/>
    </changeSet>

    <!-- need to fix the unique key on acm_file before inserting the files from cases where those
         files are also in a complaint -->
    <changeSet id="files-23-unique-key-on-file-and-folder" author="dmiller">
        <dropUniqueConstraint tableName="acm_file" constraintName="uk_version_series_id"/>
        <addUniqueConstraint tableName="acm_file"
                             columnNames="cm_version_series_id, cm_folder_id"
                             constraintName="uk_file_folder"/>
    </changeSet>

    <!-- finally time to make cm_folder_id required -->
    <changeSet id="files-26-make-folder-id-required" author="dmiller">
        <addNotNullConstraint tableName="acm_file" columnName="cm_folder_id" columnDataType="${idType}"/>
    </changeSet>

    <changeSet id="files-27-make-folder-id-unique" author="dmiller">
        <addUniqueConstraint tableName="acm_folder" columnNames="cm_cmis_folder_id"/>
    </changeSet>

    <changeSet id="files-28-add-container-id-to-file" author="dmiller">
        <addColumn tableName="acm_file">
            <column name="cm_container_id" type="${idType}">
                <constraints foreignKeyName="fk_file_container_id"
                             referencedTableName="acm_container"
                             referencedColumnNames="cm_container_id"
                             initiallyDeferred="${initially.deferred}"
                             deferrable="${deferrable}"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="files-30-make-file-container-id-required" author="dmiller">
        <addNotNullConstraint tableName="acm_file" columnName="cm_container_id" columnDataType="${idType}"/>
    </changeSet>

    <changeSet id="files-31-add-container-title" author="dmiller">
        <addColumn tableName="acm_container">
            <column name="cm_object_title" type="VARCHAR(1024)"/>
        </addColumn>
    </changeSet>

    <changeSet id="files-36-make-object-title-required" author="dmiller">
        <addNotNullConstraint tableName="acm_container" columnName="cm_object_title" columnDataType="VARCHAR(1024)"/>
    </changeSet>

    <changeSet id="files-37-add-calendar-folder-id-case-file-table-new" author="nebojsha.davidovikj">
        <addColumn tableName="acm_container">
            <column name="cm_outlook_folder_id" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>
    
   	<changeSet id="files-38-add-attachment-folder-id-in-container-table" author="riste.tutureski">
        <addColumn tableName="acm_container">
            <column name="cm_attachment_folder_id" type="VARCHAR(1024)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="files-38-add-function-based-index" author="marst">
        <preConditions onFail="MARK_RAN">
            <dbms type="oracle"/>
        </preConditions>
        <createIndex tableName="acm_folder" indexName="idx_folder_name_parent_id" unique="true">
            <column name="NVL(cm_parent_folder_id, cm_folder_id),upper(cm_folder_name)"></column>
        </createIndex>
    </changeSet>

    <changeSet id="files-39-add-object-type-in-acm-folder-table" author="dmiller">
        <addColumn tableName="acm_folder">
            <column name="cm_object_type" type="VARCHAR(100)" defaultValue="FOLDER">
                    <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="files-40-add-folder-status-in-acm-folder-table" author="dmiller">
        <addColumn tableName="acm_folder">
            <column name="cm_folder_status" type="VARCHAR(100)" defaultValue="ACTIVE">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

</databaseChangeLog>

